name: Auto-close welcomed birth issues

on:
  schedule:
    # Run every 6 hours
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  close-welcomed:
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - name: Close welcomed issues older than 24 hours
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;

            // Get open issues with 'welcomed' label
            const issues = await github.rest.issues.listForRepo({
              owner,
              repo,
              state: 'open',
              labels: 'welcomed'
            });

            const now = new Date();
            const ONE_DAY_MS = 24 * 60 * 60 * 1000;

            for (const issue of issues.data) {
              // Find when 'welcomed' label was added
              const events = await github.rest.issues.listEvents({
                owner,
                repo,
                issue_number: issue.number
              });

              const welcomedEvent = events.data.find(e =>
                e.event === 'labeled' && e.label?.name === 'welcomed'
              );

              if (welcomedEvent) {
                const labeledAt = new Date(welcomedEvent.created_at);
                const age = now - labeledAt;

                if (age > ONE_DAY_MS) {
                  console.log(`Closing issue #${issue.number} - welcomed ${Math.round(age / ONE_DAY_MS)} days ago`);

                  await github.rest.issues.createComment({
                    owner,
                    repo,
                    issue_number: issue.number,
                    body: 'ðŸŽ‰ Welcome complete! Auto-closing after 24 hours.\n\nYour Oracle is now part of the family. See you in the [Oracle Family Index](https://github.com/Soul-Brews-Studio/oracle-v2/issues/60)!'
                  });

                  await github.rest.issues.update({
                    owner,
                    repo,
                    issue_number: issue.number,
                    state: 'closed',
                    state_reason: 'completed'
                  });
                }
              }
            }
