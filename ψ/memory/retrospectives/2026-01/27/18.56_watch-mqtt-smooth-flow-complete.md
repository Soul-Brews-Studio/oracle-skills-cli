# Session Retrospective

**Session Date**: 2026-01-27
**Start Time**: ~17:37 GMT+7
**End Time**: 18:56 GMT+7
**Duration**: ~79 minutes
**Primary Focus**: /watch skill MQTT smooth flow - complete pipeline
**Session Type**: Feature Development + Bug Fixing
**Repo**: oracle-skills-cli (Soul-Brews-Studio)

## Session Summary

Extended the /watch skill from basic documentation to a complete working pipeline. Created `transcribe.ts` combo script, fixed tabId capture (subscribe before publish), removed all retain flags, and added save to Google Docs functionality. Successfully tested with multiple YouTube videos about ClawdBot.

## Timeline

- 17:37 - Completed previous /rrr --forward
- 17:42 - /recap --rich orientation
- 17:44 - Tested MQTT transcribe with retain flag
- 17:46 - User requested JSON metadata format
- 17:47 - Updated SKILL.md with MQTT smooth flow
- 17:50 - Created transcribe.ts following "code as reference" pattern
- 17:52 - First retrospective + blog draft
- 17:55 - User noticed tabId not captured
- 18:00 - Discovered cached response issue (old retained messages)
- 18:05 - Fixed: subscribe BEFORE publish
- 18:10 - Removed ALL retain flags (user: "we will not cache anything")
- 18:15 - tabId capture working! (2127157876)
- 18:20 - Added save to Google Docs (click action)
- 18:30 - Tested full flow with multiple videos
- 18:56 - Session wrap-up

## Technical Details

### Files Modified
```
src/skills/watch/SKILL.md              | +45 lines (MQTT workflow, save to docs)
src/skills/watch/scripts/transcribe.ts | NEW - 143 lines
œà/inbox/drafts/smooth-flow-blogpost.md | NEW - blog draft
œà/memory/learnings/code-as-reference.md| NEW - pattern doc
```

### Key Code: Subscribe Before Publish

```typescript
// OLD (broken): publish then subscribe ‚Üí miss response
await $`mosquitto_pub ... -m ${cmd}`
const response = await getResponse()  // Too late!

// NEW (working): subscribe first, then publish
const subProc = Bun.spawn(["mosquitto_sub", ...])
await Bun.sleep(200)  // Ensure subscriber ready
await $`mosquitto_pub ... -m ${cmd}`
const response = await subProc.stdout  // Got it!
```

### Key Fix: No Retain Anywhere

```bash
# OLD: cached responses confused reads
mosquitto_pub -r -m '...'  # BAD - retains old response

# NEW: fresh messages only
mosquitto_pub -m '...'     # GOOD - no caching
```

### MQTT Actions Used

| Action | Purpose |
|--------|---------|
| `create_tab` | New Gemini tab ‚Üí returns tabId |
| `chat` | Send prompt with tabId |
| `click` | Click üíæ button by selector |
| `select_model` | Switch fast/thinking/pro |

## üìù AI Diary

This session was a masterclass in debugging distributed systems. The smooth flow looked simple on paper - create tab, send prompt, save to docs - but the devil was in the MQTT timing.

The first major "aha" was when I kept getting `tabId: unknown`. The extension WAS returning the tabId, but my script subscribed AFTER publishing, so the response was already gone. Classic race condition. The fix - subscribe first, wait 200ms, then publish - is now burned into my memory.

The second breakthrough came when the user said "we will not cache anything." I'd been using `-r` retain flags everywhere, thinking it helped with reliability. Wrong! Old retained messages were polluting the response topic, causing confusion. Removing all retain flags cleaned up the flow immediately.

The "click to save" feature was the cherry on top. The üíæ button was already injected by our content.js, just waiting to be clicked programmatically. One MQTT command with the right selector and boom - Google Docs export.

What I loved about this session: the user's feedback was instant and clear. "very wrong eliminate it?" "now working! update the skills!" "save to docs!" No ambiguity, rapid iteration.

## What Went Well

- tabId capture finally working after subscribe-first fix
- Removed all retain flags - cleaner, more predictable
- Full pipeline tested: transcribe ‚Üí save ‚Üí docs
- Multiple videos transcribed successfully
- User feedback loop was tight and productive

## What Could Improve

- Initial MQTT timing assumptions were wrong
- Should have questioned retain flags earlier
- Could add automatic save-to-docs after transcription completes
- Error handling still minimal

## Blockers & Resolutions

- **Blocker**: tabId always "unknown"
  **Resolution**: Subscribe BEFORE publish, not after

- **Blocker**: Old cached responses polluting reads
  **Resolution**: Remove ALL `-r` retain flags

- **Blocker**: Click command not triggering save
  **Resolution**: Needed correct selector `.claude-response-actions button:first-child`

## üí≠ Honest Feedback

This was a debugging session disguised as a feature session. The "smooth flow" concept was clear from the start, but making it actually smooth required understanding MQTT timing, Chrome extension behavior, and the interaction between retained messages and subscriptions.

The user's patience was key. When something didn't work, instead of getting frustrated, they gave clear signals: "nothing clicked?" "very wrong" "now working!" This made iteration fast and focused.

I'm proud of the final result. The transcribe.ts script is clean, the tabId capture is reliable, and the save-to-docs flow works. But I'm also humbled by how many assumptions I had wrong initially.

### Friction Points

1. **MQTT timing assumptions**: I assumed publish-then-subscribe would work. Wrong. The response is transient and gone before subscription starts.

2. **Retain flag confusion**: I thought retain helped reliability. Actually it caused stale data issues. The user's "no caching" rule is correct.

3. **Chrome extension debugging**: Hard to see what's happening inside the extension. Need better logging or a debug panel.

## Lessons Learned

- **Pattern**: Subscribe BEFORE publish when expecting a response
- **Pattern**: No retain flags - fresh messages only, no caching
- **Pattern**: Test with real videos, not just echo commands
- **Discovery**: Click actions need precise selectors
- **Insight**: Distributed systems timing is everything

## Next Steps

- [ ] Auto-save to docs after transcription (detect completion)
- [ ] Add `--save` flag to transcribe.ts
- [ ] Better error messages when tabId capture fails
- [ ] Push claude-browser-proxy changes to remote

## Metrics

- **Commits**: 6 this session
- **Files changed**: 8
- **Lines added**: ~700
- **Videos transcribed**: 4 (ClawdBot series)
- **Bugs fixed**: 2 major (tabId, retain)

## ‚úÖ Retrospective Validation Checklist
- [x] AI Diary section has detailed narrative
- [x] Honest Feedback section has frank assessment
- [x] Timeline includes actual times and events
- [x] 3 Friction Points documented
- [x] Lessons Learned has actionable insights
- [x] Next Steps are specific and achievable
