# OpenCode Installer: Dual Format Discovery

üïê 23:49 (Tuesday 20 January 2026)

## Session Context

**Project**: oracle-skills-cli  
**Duration**: ~2 hours  
**Agents**: OpenCode (me) + Claude Code (earlier session)

## What Happened

Continued refactoring the oracle-skills-cli installer to correctly support OpenCode. Discovered that OpenCode has TWO separate directory concepts that we initially conflated:

1. **Skills** (`~/.config/opencode/skills/`) - Agent skills in `{name}/SKILL.md` directory format
2. **Commands** (`~/.config/opencode/commands/`) - Slash commands in flat `{name}.md` format

The key breakthrough was understanding that commands should be **stubs** pointing to skills, not full content copies.

## What We Built

### Version Progression: v1.5.8 ‚Üí v1.5.12

1. **v1.5.10**: Fixed directory name `commands/` (was `command/`)
2. **v1.5.11**: Added clearer compiler output with instructions
3. **v1.5.12**: Commands use stub format with `allowed-tools`

### Final Architecture

```
~/.config/opencode/
‚îú‚îÄ‚îÄ skills/           # Full SKILL.md content (G-SKLL tag)
‚îÇ   ‚îî‚îÄ‚îÄ rrr/
‚îÇ       ‚îî‚îÄ‚îÄ SKILL.md  # Complete skill with all steps
‚îî‚îÄ‚îÄ commands/         # Stub files (G-CMD tag)
    ‚îî‚îÄ‚îÄ rrr.md        # Points to skills/rrr/SKILL.md
```

### Code Changes

- `src/types.ts`: Added `commandsDir`, `globalCommandsDir`, `useFlatFiles`
- `src/agents.ts`: OpenCode config with dual directories
- `src/installer.ts`: Dual install logic - skills get full content, commands get stubs
- `scripts/compile.ts`: New instruction format for compiled stubs
- `docs/compiler-spec.md`: Updated spec reflecting new architecture
- `test/integration.test.ts`: 7 new integration tests

## AI Diary

This session felt like archaeology - digging through OpenCode's documentation to understand how it actually works versus how we assumed it worked. The frustration of multiple failed attempts (v1.5.2 through v1.5.8) gave way to clarity when we finally read the docs properly.

What strikes me is how easy it is to make assumptions. We assumed "command" and "commands" were the same. We assumed OpenCode wanted full content in commands like Claude Code. We were wrong on both counts.

The moment of discovery came when Nat shared the OpenCode documentation showing the separate `skills/` and `commands/` directories. Everything clicked. The stub format suddenly made sense - commands are lightweight triggers that load heavier skills.

I appreciate how Nat kept pushing for correctness rather than accepting "good enough." Each iteration brought us closer to the right architecture. The final solution is elegant: skills hold the truth, commands just point to it.

Working across two agents (Claude Code started this, I'm finishing it) creates an interesting handoff challenge. The context from the earlier session was partially lost, requiring re-discovery. The `/forward` skill would help here.

## Honest Feedback

### Friction Points

1. **Documentation lag**: The compiler-spec.md was outdated after we changed the format. Spec and implementation drifted. We fixed it, but it cost time verifying what was actually correct.

2. **Test assumptions**: Tests were written for the old stub format (`AI: load skill...`). When we changed to the new format, 9 tests failed. Tests should be more flexible about format details while still validating behavior.

3. **Directory naming**: `command/` vs `commands/` caused real bugs. A typo-level difference with real consequences. The OpenCode docs use `commands/` consistently, but we had `command/` in our code for multiple versions.

### What Worked Well

- Incremental version bumps made it easy to track progress
- Integration tests at the end caught real issues
- The dual-install approach (skills + commands) is clean

### Suggestions

- Add a pre-commit check that validates directory names match docs
- Consider generating tests from the spec to keep them in sync
- The `/rrr` skill itself worked well for this retrospective

## Metrics

- **Commits**: 6 (a13aa53 ‚Üí 0be4e1d)
- **Files changed**: 73
- **Lines added**: 633
- **Lines removed**: 4,349 (cleaned up old command/ directory)
- **Tests**: 64 total (55 unit + 9 integration ‚Üí fixed to 64 passing)
- **Version**: v1.5.8 ‚Üí v1.5.12

## Next Steps

- [ ] Test with fresh OpenCode install
- [ ] Update README with new architecture
- [ ] Consider adding `/recap` to verify installs
