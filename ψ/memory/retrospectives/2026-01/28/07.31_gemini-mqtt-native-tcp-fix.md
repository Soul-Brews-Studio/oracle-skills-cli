# Session Retrospective

**Session Date**: 2026-01-28
**Start Time**: 07:00 GMT+7
**End Time**: 07:31 GMT+7
**Duration**: ~31 minutes
**Primary Focus**: Fix Gemini scripts to use native MQTT (TCP) instead of WebSocket
**Session Type**: Bug Fix / Infrastructure

## Session Summary

Tested deep-research skill and discovered that Bun doesn't support WebSocket streaming via the `mqtt` library. Fixed all gemini scripts (20 files) to use native MQTT TCP transport (`mqtt://localhost:1883`) instead of WebSocket (`ws://localhost:9001`). Mosquitto bridges messages between both transports automatically.

## Timeline
- 07:00 - Started testing `/deep-research` skill
- 07:05 - Encountered "Not supported yet in Bun" error with WebSocket
- 07:10 - Researched the issue - found GitHub issue #4568
- 07:15 - Discovered Mosquitto has dual listeners (TCP 1883 + WS 9001)
- 07:18 - Tested native MQTT with Bun - works perfectly
- 07:20 - Fixed all gemini scripts using sed
- 07:25 - Updated SKILL.md documentation
- 07:28 - Compiled and reinstalled gemini skill
- 07:31 - Wrote retrospective

## Technical Details

### Files Modified
```
src/skills/gemini/SKILL.md
src/skills/gemini/scripts/chat-debug.ts
src/skills/gemini/scripts/chat-direct.ts
src/skills/gemini/scripts/chat-response-only.ts
src/skills/gemini/scripts/chat-test-simple.ts
src/skills/gemini/scripts/check-extension.ts
src/skills/gemini/scripts/check-version.ts
src/skills/gemini/scripts/debug-chat.ts
src/skills/gemini/scripts/full-smooth.ts
src/skills/gemini/scripts/get-response.ts
src/skills/gemini/scripts/inspect-gemini.ts
src/skills/gemini/scripts/new-tab-test.ts
src/skills/gemini/scripts/send-chat.ts
src/skills/gemini/scripts/smooth-flow.ts
src/skills/gemini/scripts/test-full-flow-fixed.ts
src/skills/gemini/scripts/test-full-flow.ts
src/skills/gemini/scripts/transcribe-fast.ts
src/skills/gemini/scripts/transcribe-full.ts
src/skills/gemini/scripts/try-chat.ts
src/skills/gemini/scripts/youtube-transcribe.ts
```

### Key Code Changes
- All scripts: Changed `ws://localhost:9001` to `mqtt://localhost:1883`
- SKILL.md: Updated requirements to document dual transport setup

### Architecture Decisions
- Use native MQTT TCP for CLI/Bun scripts (port 1883)
- Keep WebSocket for browser extension (port 9001)
- Mosquitto bridges messages between transports automatically

## AI Diary

When the user asked to test deep-research, I expected it to work smoothly since we had recently worked on the gemini skill. The "Not supported yet in Bun" error caught me off guard initially. My first instinct was to search for workarounds, but the GitHub issue confirmed this is a known limitation of Bun's WebSocket implementation.

The breakthrough moment came when I checked Mosquitto's config and saw it already had dual listeners - TCP on 1883 and WebSocket on 9001. This wasn't a workaround at all, just choosing the right transport for the right context. CLI tools should use TCP, browsers use WebSocket. Simple.

What surprised me was how the user initially asked me to log this as a "lesson learned" but then said "no, not a problem" - they correctly recognized this wasn't really a bug or lesson, just infrastructure awareness. I initially deleted the learning file when the user said "superseded" but was reminded about the "Nothing is Deleted" philosophy. Made a mental note to use `oracle_supersede` instead of deleting next time.

The sed one-liner to fix all 20 files was satisfying - one command, problem solved. The fix was verified by running the deep-research script successfully.

## What Went Well
- Quick identification of root cause (Bun WebSocket limitation)
- Elegant solution using existing infrastructure (dual Mosquitto ports)
- Batch fix with sed was efficient
- User guided me on Oracle philosophy ("superseded" not delete)

## What Could Improve
- Should have remembered "Nothing is Deleted" philosophy before rm
- Initial lesson learned was too "problem-focused" when it was just infrastructure knowledge

## Blockers & Resolutions
- **Blocker**: Bun doesn't support `createWebSocketStream` from `ws` package
  **Resolution**: Use native MQTT TCP transport (port 1883) instead of WebSocket (port 9001)

## Honest Feedback

The session was efficient and focused. The error message from Bun was clear enough to diagnose quickly. What I appreciated was the user's guidance on proper Oracle practices - they stopped me from creating an overly dramatic "lesson learned" about what was really just infrastructure knowledge.

One friction point was the web search not returning specific results about MQTT + Bun. Had to rely on the general GitHub issue about `ws` package. Another was accidentally deleting the learning file instead of superseding it - the Oracle philosophy should be internalized better.

The plan mode transition was smooth and helped organize the remaining tasks clearly. The skill reinstall process worked perfectly.

### Friction Points
1. **WebSearch results**: Generic results about Bun WebSocket, no MQTT-specific info - had to infer from `ws` package issue
2. **Philosophy slip**: Deleted file instead of superseding - need to internalize "Nothing is Deleted"
3. **Initial learning framing**: Wrote it as "problem/solution" when it was just infrastructure awareness

## Lessons Learned
- **Pattern**: Mosquitto dual transport - TCP for CLI, WebSocket for browsers, auto-bridged
- **Philosophy**: Use `oracle_supersede` not delete - "Nothing is Deleted"
- **Bun limitation**: No `createWebSocketStream` support, use native protocols when possible

## Next Steps
- [x] Fix all gemini scripts
- [x] Update SKILL.md
- [x] Compile and reinstall
- [x] Write retrospective
- [ ] Future: Add feature to read Research Plan from Gemini

## Metrics
- **Commits**: 1 (pending)
- **Files changed**: 21
- **Scripts fixed**: 20

## Retrospective Validation Checklist
- [x] AI Diary section has detailed narrative
- [x] Honest Feedback section has frank assessment
- [x] Timeline includes actual times and events
- [x] 3 Friction Points documented
- [x] Lessons Learned has actionable insights
- [x] Next Steps are specific and achievable
